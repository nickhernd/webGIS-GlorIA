version: '3.8'

services:
  # PostgreSQL con PostGIS y TimescaleDB
  postgres:
    image: timescale/timescaledb-ha:pg14-latest
    container_name: gloria-postgres
    environment:
      POSTGRES_DB: ${DB_NAME:-gloria}
      POSTGRES_USER: ${DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-gloria2025}
      POSTGRES_INITDB_ARGS: "-E UTF8"
    ports:
      - "${DB_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./databases/init.sql:/docker-entrypoint-initdb.d/01-init.sql
      - ./databases/init-extensions.sql:/docker-entrypoint-initdb.d/02-extensions.sql
    networks:
      - gloria-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-postgres} -d ${DB_NAME:-gloria}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Redis para caché y sesiones
  redis:
    image: redis:7-alpine
    container_name: gloria-redis
    command: redis-server --requirepass ${REDIS_PASSWORD:-gloria_redis_2025}
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    networks:
      - gloria-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Backend Node.js/Express
  backend:
    build:
      context: ./backend
      dockerfile: ../docker/backend.Dockerfile
    container_name: gloria-backend
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: ${BACKEND_PORT:-3000}

      # Database
      DB_USER: ${DB_USER:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-gloria2025}
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-gloria}
      DB_SCHEMA: ${DB_SCHEMA:-gloria}
      DB_POOL_MAX: ${DB_POOL_MAX:-20}
      DB_IDLE_TIMEOUT: ${DB_IDLE_TIMEOUT:-30000}
      DB_CONNECTION_TIMEOUT: ${DB_CONNECTION_TIMEOUT:-5000}

      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-gloria_redis_2025}
      CACHE_TTL: ${CACHE_TTL:-300}

      # Security
      JWT_SECRET: ${JWT_SECRET:-change_this_secret_in_production}
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:5173}
      RATE_LIMIT_ENABLED: ${RATE_LIMIT_ENABLED:-true}
      RATE_LIMIT_WINDOW: ${RATE_LIMIT_WINDOW:-15}
      RATE_LIMIT_MAX: ${RATE_LIMIT_MAX:-100}

      # External APIs
      COPERNICUS_API_URL: ${COPERNICUS_API_URL}
      COPERNICUS_USERNAME: ${COPERNICUS_USERNAME}
      COPERNICUS_PASSWORD: ${COPERNICUS_PASSWORD}
      COPERNICUS_TIMEOUT: ${COPERNICUS_TIMEOUT:-30000}

      OPENWEATHER_API_KEY: ${OPENWEATHER_API_KEY}
      OPENWEATHER_API_URL: ${OPENWEATHER_API_URL:-https://api.openweathermap.org/data/2.5}
      OPENWEATHER_TIMEOUT: ${OPENWEATHER_TIMEOUT:-10000}

      # Python Service
      PYTHON_SERVICE_URL: http://python-service:8000
    ports:
      - "${BACKEND_PORT:-3000}:3000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - gloria-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # Frontend Vue 3
  frontend:
    build:
      context: ./frontend
      dockerfile: ../docker/frontend.Dockerfile
      args:
        VITE_API_URL: ${VITE_API_URL:-http://localhost:3000}
    container_name: gloria-frontend
    environment:
      VITE_API_URL: ${VITE_API_URL:-http://localhost:3000}
    ports:
      - "${FRONTEND_PORT:-5173}:80"
    depends_on:
      - backend
    networks:
      - gloria-network
    restart: unless-stopped

  # Python Service para predicciones ML
  python-service:
    build:
      context: ./python-services
      dockerfile: ../docker/python.Dockerfile
    container_name: gloria-python
    environment:
      PYTHONUNBUFFERED: 1
      DB_USER: ${DB_USER:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-gloria2025}
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-gloria}
    ports:
      - "${PYTHON_PORT:-8000}:8000"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - gloria-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # PgAdmin (opcional - para administración de BD)
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: gloria-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@gloria.local}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
      PGADMIN_LISTEN_PORT: 80
    ports:
      - "${PGADMIN_PORT:-5050}:80"
    depends_on:
      - postgres
    networks:
      - gloria-network
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    restart: unless-stopped
    profiles:
      - dev

networks:
  gloria-network:
    driver: bridge
    name: gloria-network

volumes:
  postgres_data:
    name: gloria-postgres-data
  redis_data:
    name: gloria-redis-data
  pgadmin_data:
    name: gloria-pgadmin-data
